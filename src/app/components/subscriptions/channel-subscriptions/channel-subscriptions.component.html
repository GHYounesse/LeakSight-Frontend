<div class="subscriptions-container">
  <!-- Header Section -->
  <div class="header-section">
    <h1 class="page-title">
      <span class="title-icon">🔔</span>
      Channel Subscriptions
    </h1>
    <p class="page-subtitle">Manage your Telegram channel monitoring and keyword alerts</p>
  </div>

  <!-- Action Bar -->
  <div class="action-bar">
    <div class="action-group">
      <button 
        class="btn btn-primary" 
        (click)="startNew()" 
        [disabled]="loading || isEditing || showBulkForm">
        <span class="btn-icon">➕</span>
        Add Subscription
      </button>
      
      <button 
        class="btn btn-secondary" 
        (click)="startBulkNew()" 
        [disabled]="loading || isEditing || showBulkForm">
        <span class="btn-icon">📋</span>
        Bulk Subscribe
      </button>
      
      <button 
        class="btn btn-info" 
        (click)="toggleGroupedView()" 
        [disabled]="loading">
        <span class="btn-icon">🔗</span>
        {{ showGroupedView ? 'List View' : 'Grouped View' }}
      </button>
    </div>

    <!-- Selection Actions (shown when channels are selected) -->
    <div class="selection-actions" *ngIf="selectedChannels.size > 0 && !showGroupedView">
      <span class="selection-count">{{ selectedChannels.size }} selected</span>
      <button class="btn btn-warning btn-sm" (click)="startBulkEditSelected()">
        <span class="btn-icon">✏️</span>
        Edit Selected
      </button>
      <button class="btn btn-danger btn-sm" (click)="deleteBulkSubscriptions()">
        <span class="btn-icon">🗑️</span>
        Delete Selected
      </button>
      <button class="btn btn-secondary btn-sm" (click)="clearSelection()">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <span>Processing...</span>
  </div>

  <!-- Single Subscription Form -->
  <div class="form-section" *ngIf="isEditing">
    <div class="form-card">
      <div class="form-header">
        <h3>{{ editingIndex >= 0 ? 'Edit Subscription' : 'New Subscription' }}</h3>
        <button class="btn-close" (click)="cancelEdit()">✕</button>
      </div>
      
      <form [formGroup]="subscriptionForm" (ngSubmit)="saveSubscription()">
        <div class="form-group">
          <label for="channel_username">Channel Username</label>
          <input 
            type="text" 
            id="channel_username"
            formControlName="channel_username" 
            placeholder="Enter channel username (without @)"
            class="form-input">
          <div class="form-error" *ngIf="subscriptionForm.get('channel_username')?.errors?.['required'] && subscriptionForm.get('channel_username')?.touched">
            Channel username is required
          </div>
          <div class="form-error" *ngIf="subscriptionForm.get('channel_username')?.errors?.['pattern'] && subscriptionForm.get('channel_username')?.touched">
            Invalid format. Use only letters, numbers, and underscores
          </div>
        </div>

        <div class="keywords-section">
          <div class="keywords-header">
            <h4>Keywords</h4>
            <button type="button" class="btn btn-secondary btn-sm" (click)="addKeyword()">
              <span class="btn-icon">➕</span>
              Add Keyword
            </button>
          </div>

          <div class="keywords-list" formArrayName="keywords">
            <div class="keyword-item" *ngFor="let keyword of keywordsArray.controls; let i = index" [formGroupName]="i">
              <div class="keyword-input-group">
                <input 
                  type="text" 
                  formControlName="keyword" 
                  placeholder="Enter keyword"
                  class="form-input">
                <div class="keyword-options">
                  <label class="checkbox-label">
                    <input type="checkbox" formControlName="case_sensitive">
                    <span class="checkmark"></span>
                    Case Sensitive
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" formControlName="regex">
                    <span class="checkmark"></span>
                    Regex
                  </label>
                </div>
                <button type="button" class="btn btn-danger btn-sm" (click)="removeKeyword(i)">
                  <span class="btn-icon">🗑️</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Suggested Keywords -->
          <div class="suggested-keywords">
            <h5>Suggested Keywords</h5>
            <div class="keyword-tags">
              <button 
                type="button" 
                class="keyword-tag" 
                *ngFor="let keyword of suggestedKeywords" 
                (click)="addSuggestedKeyword(keyword)">
                {{ keyword }}
              </button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success" [disabled]="!subscriptionForm.valid || keywordsArray.length === 0">
            <span class="btn-icon">💾</span>
            {{ editingIndex >= 0 ? 'Update' : 'Create' }} Subscription
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Subscription Form -->
  <div class="form-section" *ngIf="showBulkForm">
    <div class="form-card">
      <div class="form-header">
        <h3>Bulk Operations</h3>
        <button class="btn-close" (click)="cancelBulkEdit()">✕</button>
      </div>
      
      <form [formGroup]="bulkForm">
        <div class="form-group">
          <label for="bulk_channels">Channel Usernames</label>
          <textarea 
            id="bulk_channels"
            formControlName="channel_usernames" 
            placeholder="Enter channel usernames separated by commas (e.g., channel1, channel2, channel3)"
            class="form-textarea"
            rows="3"></textarea>
          <div class="form-help">Enter multiple channel usernames separated by commas</div>
        </div>

        <div class="keywords-section">
          <div class="keywords-header">
            <h4>Keywords</h4>
            <button type="button" class="btn btn-secondary btn-sm" (click)="addKeyword(undefined, true)">
              <span class="btn-icon">➕</span>
              Add Keyword
            </button>
          </div>

          <div class="keywords-list" formArrayName="keywords">
            <div class="keyword-item" *ngFor="let keyword of bulkKeywordsArray.controls; let i = index" [formGroupName]="i">
              <div class="keyword-input-group">
                <input 
                  type="text" 
                  formControlName="keyword" 
                  placeholder="Enter keyword"
                  class="form-input">
                <div class="keyword-options">
                  <label class="checkbox-label">
                    <input type="checkbox" formControlName="case_sensitive">
                    <span class="checkmark"></span>
                    Case Sensitive
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" formControlName="regex">
                    <span class="checkmark"></span>
                    Regex
                  </label>
                </div>
                <button type="button" class="btn btn-danger btn-sm" (click)="removeKeyword(i, true)">
                  <span class="btn-icon">🗑️</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Suggested Keywords for Bulk -->
          <div class="suggested-keywords">
            <h5>Suggested Keywords</h5>
            <div class="keyword-tags">
              <button 
                type="button" 
                class="keyword-tag" 
                *ngFor="let keyword of suggestedKeywords" 
                (click)="addSuggestedKeyword(keyword, true)">
                {{ keyword }}
              </button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-success" 
            (click)="saveBulkSubscription()" [class.btn-hidden]="!showCreateButton"
            [disabled]="!bulkForm.valid || bulkKeywordsArray.length === 0">
            <span class="btn-icon">📋</span>
            Create Bulk Subscriptions
          </button>
          <button 
            type="button" 
            class="btn btn-warning" 
            (click)="updateBulkSubscriptions()"
            [disabled]="!bulkForm.valid || bulkKeywordsArray.length === 0 || selectedChannels.size === 0">
            <span class="btn-icon">🔄</span>
            Update Selected
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelBulkEdit()">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Selection Controls (List View) -->
  <div class="selection-controls" *ngIf="!showGroupedView && subscriptions.length > 0 && !isEditing && !showBulkForm">
    <div class="selection-actions-top">
      <button class="btn btn-secondary btn-sm" (click)="selectAllChannels()">
        <span class="btn-icon">☑️</span>
        Select All
      </button>
      <button class="btn btn-secondary btn-sm" (click)="clearSelection()" *ngIf="selectedChannels.size > 0">
        <span class="btn-icon">☐</span>
        Clear All
      </button>
    </div>
  </div>

  <!-- Grouped View -->
  <div class="grouped-view" *ngIf="showGroupedView && !isEditing && !showBulkForm">
    <div class="grouped-header">
      <h3>Subscriptions Grouped by Keywords</h3>
      <span class="group-count">{{ groupedSubscriptions.length }} unique keyword sets</span>
    </div>
    
    <div class="grouped-list">
      <div class="group-card" *ngFor="let group of groupedSubscriptions">
        <div class="group-header">
          <div class="group-info">
            <div class="group-channels">
              <strong>{{ group.channels.length }} Channels:</strong>
              <span class="channels-text">{{ getChannelsDisplayText(group.channels) }}</span>
            </div>
            <div class="group-keywords">
              <strong>Keywords:</strong>
              <div class="keyword-badges">
                <span 
                  class="keyword-badge" 
                  *ngFor="let keyword of group.keywords"
                  [title]="getKeywordTypeTooltip(keyword)">
                  <span class="keyword-icon">{{ getKeywordTypeIcon(keyword) }}</span>
                  {{ keyword.keyword }}
                </span>
              </div>
            </div>
          </div>
          
          <div class="group-actions">
            <button class="btn btn-warning btn-sm" (click)="updateGroupedSubscriptions(group)">
              <span class="btn-icon">✏️</span>
              Edit Group
            </button>
            <button class="btn btn-danger btn-sm" (click)="deleteGroupedSubscriptions(group)">
              <span class="btn-icon">🗑️</span>
              Delete Group
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Individual Subscriptions List View -->
  <div class="subscriptions-list" *ngIf="!showGroupedView && !isEditing && !showBulkForm">
    <div class="list-header" *ngIf="subscriptions.length > 0">
      <h3>Active Subscriptions</h3>
      <span class="subscription-count">{{ subscriptions.length }} total subscriptions</span>
    </div>

    <div class="empty-state" *ngIf="subscriptions.length === 0 && !loading">
      <div class="empty-icon">📭</div>
      <h3>No Subscriptions Found</h3>
      <p>You haven't subscribed to any channels yet. Start by creating your first subscription!</p>
      <button class="btn btn-primary" (click)="startNew()">
        <span class="btn-icon">➕</span>
        Create First Subscription
      </button>
    </div>

    <div class="subscription-cards">
      <div class="subscription-card" 
           *ngFor="let subscription of subscriptions; let i = index"
           [class.selected]="isChannelSelected(subscription.channel_username)">
        
        <!-- Selection Checkbox -->
        <div class="card-selection">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [checked]="isChannelSelected(subscription.channel_username)"
              (change)="toggleChannelSelection(subscription.channel_username)">
            <span class="checkmark"></span>
          </label>
        </div>

        <!-- Card Content -->
        <div class="card-content">
          <div class="card-header">
            <div class="channel-info">
              <h4 class="channel-name">
                <span class="channel-icon">📺</span>
                @{{ getChannelDisplayName(subscription.channel_username) }}
              </h4>
              <div class="subscription-meta">
                <span class="created-date" *ngIf="subscription.created_at">
                  Created: {{ formatDate(subscription.created_at) }}
                </span>
                <span class="status-badge" [class.enabled]="subscription.enabled" [class.disabled]="!subscription.enabled">
                  {{ subscription.enabled ? 'Active' : 'Disabled' }}
                </span>
              </div>
            </div>

            <div class="card-actions">
              <button class="btn btn-info btn-sm" (click)="toggleSubscription(i)" [disabled]="loading">
                <span class="btn-icon">{{ subscription.enabled ? '⏸️' : '▶️' }}</span>
                <!-- {{ subscription.enabled ? 'Disable' : 'Enable' }} -->
              </button>
              <button class="btn btn-warning btn-sm" (click)="startEdit(subscription, i)" [disabled]="loading">
                <span class="btn-icon">✏️</span>
                <!-- Edit -->
              </button>
              <button class="btn btn-danger btn-sm" (click)="deleteSubscription(i)" [disabled]="loading">
                <span class="btn-icon">🗑️</span>
                <!-- Delete -->
              </button>
            </div>
          </div>

          <div class="keywords-display">
            <h5>Monitored Keywords</h5>
            <div class="keyword-badges">
              <span 
                class="keyword-badge" 
                *ngFor="let keyword of subscription.keywords"
                [title]="getKeywordTypeTooltip(keyword)">
                <span class="keyword-icon">{{ getKeywordTypeIcon(keyword) }}</span>
                {{ keyword.keyword }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bulk Selection Footer -->
    <div class="bulk-footer" *ngIf="selectedChannels.size > 0">
      <div class="bulk-actions">
        <span class="selection-summary">{{ selectedChannels.size }} of {{ subscriptions.length }} subscriptions selected</span>
        <div class="bulk-buttons">
          <button class="btn btn-warning" (click)="startBulkEditSelected()">
            <span class="btn-icon">✏️</span>
            Edit {{ selectedChannels.size }} Selected
          </button>
          <button class="btn btn-danger" (click)="deleteBulkSubscriptions()">
            <span class="btn-icon">🗑️</span>
            Delete {{ selectedChannels.size }} Selected
          </button>
        </div>
      </div>
    </div>
  </div>
</div>